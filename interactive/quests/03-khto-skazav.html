<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–≤–µ—Å—Ç ¬´–•—Ç–æ —Å–∫–∞–∑–∞–≤?¬ª ‚Äî –ú–æ–≤–∞ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ</title>
  <meta name="description" content="–í–ø—ñ–∑–Ω–∞–π –∞–≤—Ç–æ—Ä–∞ —Ü–∏—Ç–∞—Ç–∏ –∞–±–æ –∞—Ñ–æ—Ä–∏–∑–º—É –ø—Ä–æ –º–æ–≤—É, –∫—É–ª—å—Ç—É—Ä—É —á–∏ –º–∏—Å–ª–µ–Ω–Ω—è. –ü—ñ–¥–∫–∞–∑–∫–∏, –ø–æ—è—Å–Ω–µ–Ω–Ω—è, –±–µ–π–¥–∂—ñ, —Ç–∞–π–º–µ—Ä, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É." />
  <meta name="color-scheme" content="light" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --blue: #4BA3C3; --blue-dark: #1E3A5F; --gray-bg: #F5F7FA;
      --text: #2C2C2C; --muted: #6B7280; --border: #D1D5DB;
      --card-shadow: 0 10px 22px rgba(0,0,0,.08);
      --ok:#16a34a; --warn:#ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', sans-serif; background-color: var(--gray-bg);
      color: var(--text); line-height: 1.7; margin: 0;
      display: flex; flex-direction: column;
    }
    .page-header {
      background: linear-gradient(90deg, var(--blue-dark) 0%, var(--blue) 100%);
      color: #fff; padding: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.10);
      position: sticky; top: 0; z-index: 50;
    }
    .header-nav { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: #fff; text-decoration: none; font-weight: 600; font-size: 0.95rem; transition: opacity 0.2s ease; }
    .back-link:hover { opacity: 0.85; }
    .back-link svg { width: 20px; height: 20px; }
    .guidebook-title { font-size: 0.9rem; opacity: 0.9; margin-left: auto; margin-right: 1rem; }
    .guidebook-title strong { font-weight: 600; }
    @media (max-width: 640px) { .guidebook-title { display: none; } .back-link { margin-right: auto; } }
    .main-content { flex-grow: 1; max-width: 900px; width: 100%; margin: 1.5rem auto; padding: 0 1rem; }
    .content-wrapper { background: #fff; border-radius: 1rem; padding: 2rem 2.5rem; border: 1px solid var(--border); box-shadow: 0 6px 14px rgba(0, 0, 0, 0.05); }
    @media (max-width: 640px) { .content-wrapper { padding: 1.5rem; } }
    .content-wrapper h1 { font-size: clamp(1.6rem, 2.5vw + 1rem, 2.25rem); font-weight: 700; color: var(--blue-dark); margin-top: 0; margin-bottom: 1rem; line-height: 1.3; }
    .content-wrapper h2 { font-size: 1.4rem; font-weight: 600; color: var(--blue-dark); margin-top: 1.8rem; margin-bottom: 0.8rem; }
    .content-wrapper p { margin-top: 0; margin-bottom: 1.5rem; font-size: 1.05rem; color: var(--text); }
    .content-wrapper ul { padding-left: 1.5rem; margin-bottom: 1rem; list-style: disc; }
    .content-wrapper li { margin-bottom: 0.5rem; font-size: 1.05rem; }
    .content-wrapper strong { font-weight: 600; color: var(--text); }
    footer { text-align: center; padding: 1.5rem 1rem; font-size: 0.9rem; color: var(--muted); background: #fff; border-top: 1px solid var(--border); margin-top: auto; }

    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .7rem;border-radius:999px;border:1px solid var(--border);background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.7rem 1rem;border-radius:.9rem;border:1px solid var(--border);transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--blue);color:#fff;border-color:var(--blue)}
    .btn-primary:disabled{opacity:.6}
    .btn-ghost{background:#fff}
    .opt{border:1px solid var(--border);border-radius:.9rem;padding:1rem;background:#fff;cursor:pointer;display:flex;gap:.8rem;align-items:flex-start}
    .opt:hover{border-color:var(--blue)}
    .opt.correct{border-color:var(--ok);box-shadow:0 0 0 3px rgba(22,163,74,.15)}
    .opt.wrong{border-color:var(--warn);box-shadow:0 0 0 3px rgba(239,68,68,.12)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85rem; background:#f3f4f6; border:1px solid #e5e7eb; border-bottom-width:2px; padding:.1rem .4rem; border-radius:.4rem}
    .card{border:1px solid var(--border);border-radius:1rem;box-shadow:var(--card-shadow);background:#fff}

    dialog::backdrop{background:rgba(0,0,0,.45)}
    dialog{border:none;border-radius:1rem;max-width:680px;width:92%;padding:0;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .modal-body{padding:1.25rem}

    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    blockquote{font-style:italic;position:relative;padding-left:1rem}
    blockquote:before{content:'‚Äú';position:absolute;left:-.2rem;top:-.1rem;font-size:2rem;opacity:.35}

    @keyframes shake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-5px)} 40%,80%{transform:translateX(5px)} }
    .shake{animation:shake .5s ease-in-out}
    #toast{position:fixed;bottom:2rem;left:50%;transform:translate(-50%,150%);background:#333;color:#fff;padding:.8rem 1.5rem;border-radius:999px;font-size:.9rem;box-shadow:0 4px 10px rgba(0,0,0,.2);transition:transform .3s ease-in-out;z-index:100;opacity:0}
    #toast.show{transform:translate(-50%,0);opacity:1}
  </style>
</head>
<body class="flex flex-col min-h-screen">
  <header class="page-header">
    <nav class="header-nav" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è –∫–≤–µ—Å—Ç—É">
      <!-- === –ó–ú–Ü–ù–ï–ù–û === -->
      <a href="index.html" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        –ù–∞–∑–∞–¥ –¥–æ –∑–∞–≤–¥–∞–Ω—å
      </a>
      <!-- === –ö–Ü–ù–ï–¶–¨ –ó–ú–Ü–ù === -->
      <div class="guidebook-title">–ü–æ—Å—ñ–±–Ω–∏–∫: <strong>–ú–æ–≤–∞ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ</strong></div>
    </nav>
  </header>

  <main class="main-content">
    <div class="content-wrapper">
      <h1>–ö–≤–µ—Å—Ç ¬´–•—Ç–æ —Å–∫–∞–∑–∞–≤?¬ª</h1>
      <p>–í–ø—ñ–∑–Ω–∞–π –∞–≤—Ç–æ—Ä–∞ —Ü–∏—Ç–∞—Ç–∏ –ø—Ä–æ –º–æ–≤—É, –∫—É–ª—å—Ç—É—Ä—É —á–∏ –º–∏—Å–ª–µ–Ω–Ω—è.</p>

      <section class="mb-6">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
          <div class="flex flex-wrap items-center gap-3">
            <span class="chip"><span class="font-semibold" id="totalCount">‚Äî</span> —Ü–∏—Ç–∞—Ç</span>
            <span class="chip"><span id="progressChip">0 / 0</span></span>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <label class="text-sm btn btn-ghost"><input id="shuffleToggle" type="checkbox" class="h-4 w-4 mr-2"> –ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏</label>
            <label class="text-sm btn btn-ghost"><input id="timedToggle" type="checkbox" class="h-4 w-4 mr-2"> –¢–∞–π–º–µ—Ä 45—Å</label>
            <label class="text-sm btn btn-ghost"><input id="hintModeToggle" type="checkbox" class="h-4 w-4 mr-2" checked> –ü—ñ–¥–∫–∞–∑–∫–∏ —É–≤—ñ–º–∫–Ω–µ–Ω—ñ</label>
            <button id="restartBtn" class="btn" title="–ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ">‚ü≤ –ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
          </div>
        </div>
        <div class="mt-4">
          <div class="w-full bg-gray-200 rounded-full h-3" aria-hidden="true">
            <div id="progressBar" class="h-3 rounded-full bg-[var(--blue)]" style="width:0%"></div>
          </div>
        </div>
      </section>

      <section id="taskArea" aria-live="polite">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-sm text-[var(--muted)]" id="taskCounter">–¶–∏—Ç–∞—Ç–∞ 1/‚Äî</div>
            <h2 class="text-xl md:text-2xl font-semibold mt-1">–í–ø—ñ–∑–Ω–∞–π –∞–≤—Ç–æ—Ä–∞</h2>
          </div>
          <div class="text-right">
            <div id="timerBox" class="hidden text-sm"><span class="font-semibold">–¢–∞–π–º–µ—Ä:</span> <span id="timer">45</span> —Å</div>
          </div>
        </div>

        <div class="mt-4 p-4 bg-[#f9fafb] rounded-xl border border-[var(--border)]" id="promptBox">
          <blockquote class="text-lg" id="quoteText">‚Ä¶</blockquote>
        </div>

        <div class="mt-4 grid gap-3" id="optionsBox" role="group" aria-label="–ê–≤—Ç–æ—Ä–∏"></div>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <button id="hintBtn" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É">üí° –ü—ñ–¥–∫–∞–∑–∫–∞</button>
          <button id="checkBtn" class="btn btn-primary" title="–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å">‚úî –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
          <button id="nextBtn" class="btn" title="–ù–∞—Å—Ç—É–ø–Ω–∞ —Ü–∏—Ç–∞—Ç–∞" disabled>‚Üí –î–∞–ª—ñ</button>
          <button id="skipBtn" class="btn" title="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —Ü–∏—Ç–∞—Ç—É">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
        </div>

        <div id="hintBox" class="mt-3 hidden text-sm bg-blue-50 border border-blue-200 text-blue-900 rounded-lg p-3"></div>
        <div id="explainBox" class="mt-3 hidden text-sm bg-green-50 border border-green-200 text-green-900 rounded-lg p-3"></div>
        <div id="contextBox" class="mt-3 hidden text-sm bg-gray-50 border border-gray-200 text-gray-800 rounded-lg p-3"></div>
      </section>
    </div>
  </main>

  <footer>
    ¬© 2025 –í–°–ü ¬´–ê–≥—Ä–∞—Ä–Ω–æ-–µ–∫–æ–Ω–æ–º—ñ—á–Ω–∏–π —Ñ–∞—Ö–æ–≤–∏–π –∫–æ–ª–µ–¥–∂ –ü–î–ê–£¬ª. –ü—Ä–æ—î–∫—Ç ¬´–ú–æ–≤–∞ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ¬ª.
  </footer>

  <dialog id="resultModal" role="dialog" aria-modal="true" aria-labelledby="resTitle">
    <div class="bg-[var(--blue-dark)] text-white rounded-t-[1rem] p-5">
      <h3 id="resTitle" class="text-xl font-semibold">–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–≤–µ—Å—Ç—É</h3>
      <p class="opacity-90 text-sm">–ù–∞—Å–∫—ñ–ª—å–∫–∏ –¥–æ–±—Ä–µ —Ç–∏ –≤–ø—ñ–∑–Ω–∞—î—à –≥–æ–ª–æ—Å–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –¥—É–º–∫–∏?</p>
    </div>
    <div class="modal-body">
      <div class="grid gap-3">
        <div class="flex flex-wrap items-center gap-3">
          <span class="chip"><strong>–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö:</strong> <span id="resRight">0</span></span>
          <span class="chip"><strong>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö:</strong> <span id="resWrong">0</span></span>
          <span class="chip"><strong>–ß–∞—Å:</strong> <span id="resTime">‚Äî</span></span>
        </div>
        <div class="mt-2" id="badgeBox"></div>
        <div class="mt-2 text-sm text-[var(--muted)]" id="resTip"></div>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4 p-3 border-t">
        <button class="btn" id="closeModalBtn">–ì–∞—Ä–∞–∑–¥</button>
        <button class="btn btn-primary" id="restartModalBtn">–ü—Ä–æ–π—Ç–∏ —â–µ —Ä–∞–∑</button>
      </div>
    </div>
  </dialog>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const TASKS_QUOTES_BASE = [
      { quote: '–ú–æ–≤–∞ ‚Äî —Ü–µ –¥—É—à–∞ –Ω–∞—Ä–æ–¥—É.', opts: ['–ü–∞–Ω—Ç–µ–ª–µ–π–º–æ–Ω –ö—É–ª—ñ—à','–¢–∞—Ä–∞—Å –®–µ–≤—á–µ–Ω–∫–æ','–Ü–≤–∞–Ω –§—Ä–∞–Ω–∫–æ'], correct: 0, hint: '–ü–∏—Å—å–º–µ–Ω–Ω–∏–∫ —ñ –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á, —Å—É—á–∞—Å–Ω–∏–∫ –®–µ–≤—á–µ–Ω–∫–∞.', explain: '–í–∏—Å–ª—ñ–≤ –ü–∞–Ω—Ç–µ–ª–µ–π–º–æ–Ω–∞ –ö—É–ª—ñ—à–∞, –ø–∏—Å—å–º–µ–Ω–Ω–∏–∫–∞, –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞, —ñ—Å—Ç–æ—Ä–∏–∫–∞.', context: '–ö—ñ–Ω–µ—Ü—å XIX —Å—Ç.; —Ç–µ–º–∞ ‚Äî –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å.' },
      { quote: '–£ –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞ —Å–≤–æ—è –¥–æ–ª—è.', opts: ['–Ü–≤–∞–Ω –§—Ä–∞–Ω–∫–æ','–õ–µ—Å—è –£–∫—Ä–∞—ó–Ω–∫–∞','–û–ª—å–≥–∞ –ö–æ–±–∏–ª—è–Ω—Å—å–∫–∞'], correct: 0, hint: '–ö–∞–º–µ–Ω—è—Ä —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –¥—É—Ö—É.', explain: '–ê–≤—Ç–æ—Ä ‚Äî –Ü–≤–∞–Ω –§—Ä–∞–Ω–∫–æ. –ê—Ñ–æ—Ä–∏–∑–º –ø—Ä–æ –≤–∞–≥—É —Å–ª–æ–≤–∞ —É –∂–∏—Ç—Ç—ñ –Ω–∞—Ä–æ–¥—É.', context: '–ö—ñ–Ω–µ—Ü—å XIX ‚Äî –ø–æ—á–∞—Ç–æ–∫ XX —Å—Ç.' },
      { quote: '–°–ª–æ–≤–æ ‚Äî –≤–µ–ª–µ—Ç–µ–Ω—å, –∫–æ–ª–∏ –¥—É–º–∫–∞ –≤–µ–ª–∏–∫–∞.', opts: ['–õ–µ—Å—è –£–∫—Ä–∞—ó–Ω–∫–∞','–ú–∏—Ö–∞–π–ª–æ –î—Ä–∞–≥–æ–º–∞–Ω–æ–≤','–Ü–≤–∞–Ω –û–≥—ñ—î–Ω–∫–æ'], correct: 0, hint: '–ü–æ–µ—Ç–µ—Å–∞ —Å–∏–ª–∏ –¥—É—Ö—É.', explain: '–õ–µ—Å—è –£–∫—Ä–∞—ó–Ω–∫–∞ –Ω–∞–≥–æ–ª–æ—à—É–≤–∞–ª–∞ –Ω–∞ —î–¥–Ω–æ—Å—Ç—ñ –¥—É–º–∫–∏ –π —Å–ª–æ–≤–∞.', context: '' },
      { quote: '–ù–∞—Ü—ñ—ó –≤–º–∏—Ä–∞—é—Ç—å –Ω–µ –≤—ñ–¥ —ñ–Ω—Ñ–∞—Ä–∫—Ç—É, —Å–ø–æ—á–∞—Ç–∫—É —ó–º –≤—ñ–¥–±–∏—Ä–∞—î –º–æ–≤—É.', opts: ['–õ—ñ–Ω–∞ –ö–æ—Å—Ç–µ–Ω–∫–æ','–û–∫—Å–∞–Ω–∞ –ó–∞–±—É–∂–∫–æ','–í–∞—Å–∏–ª—å –°—Ç—É—Å'], correct: 0, hint: '–ê–≤—Ç–æ—Ä–∫–∞ ¬´–ú–∞—Ä—É—Å—è –ß—É—Ä–∞–π¬ª.', explain: '–í–∏—Å–ª—ñ–≤ –õ—ñ–Ω–∏ –ö–æ—Å—Ç–µ–Ω–∫–æ –ø—Ä–æ –º–æ–≤—É —è–∫ –æ—Å–Ω–æ–≤—É –Ω–∞—Ü—ñ—ó.', context: '' },
      { quote: '–ù–∞—Ä–æ–¥, —â–æ –Ω–µ —à–∞–Ω—É—î —Å–≤–æ—î—ó –º–æ–≤–∏, –Ω–µ –º–∞—Ç–∏–º–µ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ.', opts: ['–Ü–≤–∞–Ω –û–≥—ñ—î–Ω–∫–æ','–ú–∏—Ç—Ä–æ–ø–æ–ª–∏—Ç –ê–Ω–¥—Ä–µ–π –®–µ–ø—Ç–∏—Ü—å–∫–∏–π','–ú–∏—Ö–∞–π–ª–æ –ì—Ä—É—à–µ–≤—Å—å–∫–∏–π'], correct: 0, hint: '–£—á–µ–Ω–∏–π —ñ –º–æ–≤–æ–∑–Ω–∞–≤–µ—Ü—å, —Ç–∞–∫–æ–∂ ‚Äî –º–∏—Ç—Ä–æ–ø–æ–ª–∏—Ç –Ü–ª–∞—Ä—ñ–æ–Ω.', explain: '–Ü–≤–∞–Ω –û–≥—ñ—î–Ω–∫–æ (–º–∏—Ç—Ä–æ–ø–æ–ª–∏—Ç –Ü–ª–∞—Ä—ñ–æ–Ω) –ø—Ä–æ –∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–≤–∏.', context: '' },
      { quote: '–°–ª–æ–≤–∞ –º–∞—é—Ç—å —Å–∏–ª—É –±—É–¥—É–≤–∞—Ç–∏ —ñ —Ä—É–π–Ω—É–≤–∞—Ç–∏.', opts: ['–ì—Ä–∏–≥–æ—Ä—ñ–π –°–∫–æ–≤–æ—Ä–æ–¥–∞','–ú–∏–∫–æ–ª–∞ –ì–æ–≥–æ–ª—å','–ú–∏—Ç—Ä–æ–ø–æ–ª–∏—Ç –ê–Ω–¥—Ä–µ–π –®–µ–ø—Ç–∏—Ü—å–∫–∏–π'], correct: 2, hint: '–î—É—Ö–æ–≤–Ω–∏–π —ñ –≥—Ä–æ–º–∞–¥—Å—å–∫–∏–π –¥—ñ—è—á –ì–∞–ª–∏—á–∏–Ω–∏.', explain: '–ê–Ω–¥—Ä–µ–π –®–µ–ø—Ç–∏—Ü—å–∫–∏–π ‚Äî –ø—Ä–æ –º–æ—Ä–∞–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å —Å–ª–æ–≤–∞.', context: '' },
      { quote: '–î—É–º–∫–∞ –±–µ–∑ —Å–ª–æ–≤–∞ ‚Äî —Ç—ñ–Ω—å, —Å–ª–æ–≤–æ –±–µ–∑ –¥—É–º–∫–∏ ‚Äî –∑–≤—É–∫.', opts: ['–ì—Ä–∏–≥–æ—Ä—ñ–π –°–∫–æ–≤–æ—Ä–æ–¥–∞','–ü–∞–º—Ñ—ñ–ª –Æ—Ä–∫–µ–≤–∏—á','–ú–∏–∫–æ–ª–∞ –ö–æ—Å—Ç–æ–º–∞—Ä–æ–≤'], correct: 0, hint: '–§—ñ–ª–æ—Å–æ—Ñ-–º–∞–Ω–¥—Ä—ñ–≤–Ω–∏–∫.', explain: '–ì—Ä–∏–≥–æ—Ä—ñ–π –°–∫–æ–≤–æ—Ä–æ–¥–∞ –ø—Ä–æ —î–¥–Ω—ñ—Å—Ç—å –¥—É–º–∫–∏ —ñ —Å–ª–æ–≤–∞.', context: '' },
      { quote: '–ú–æ–≤–∞ —Ä–æ—Å—Ç–µ —Ä–∞–∑–æ–º –∑ –¥—É—à–µ—é –Ω–∞—Ä–æ–¥—É.', opts: ['–û–ª–µ–∫—Å–∞–Ω–¥—Ä –ü–æ—Ç–µ–±–Ω—è','–ë–æ—Ä–∏—Å –ì—Ä—ñ–Ω—á–µ–Ω–∫–æ','–ü–∞–Ω—Ç–µ–ª–µ–π–º–æ–Ω –ö—É–ª—ñ—à'], correct: 0, hint: '–í–∏–¥–∞—Ç–Ω–∏–π –º–æ–≤–æ–∑–Ω–∞–≤–µ—Ü—å —ñ –ø—Å–∏—Ö–æ–ª–æ–≥ –º–æ–≤–∏.', explain: '–ü–æ—Ç–µ–±–Ω—è –ø—Ä–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω—É –ø—Ä–∏—Ä–æ–¥—É –º–æ–≤–∏.', context: '' },
      { quote: '–•—Ç–æ –º–æ–≤–∏ —Å–≤–æ—î—ó —Ü—É—Ä–∞—î—Ç—å—Å—è, —Ç–æ–π —Å–∞–º —Å–µ–±–µ –≤—ñ–¥—Ä—ñ–∫–∞—î—Ç—å—Å—è.', opts: ['–ë–æ—Ä–∏—Å –ì—Ä—ñ–Ω—á–µ–Ω–∫–æ','–ú–∏–∫–æ–ª–∞ –ö—É–ª—ñ—à','–í–∞—Å–∏–ª—å –°—Ç—É—Å'], correct: 0, hint: '–õ–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ, –ø—Ä–æ—Å–≤—ñ—Ç—è–Ω–∏–Ω.', explain: '–ë–æ—Ä–∏—Å –ì—Ä—ñ–Ω—á–µ–Ω–∫–æ ‚Äî –ø—Ä–æ —Å–∞–º–æ–ø–æ—à–∞–Ω—É —á–µ—Ä–µ–∑ –º–æ–≤—É.', context: '' },
      { quote: '–¢–∏, —Å–ª–æ–≤–æ, ‚Äî –º–æ—è –∑–±—Ä–æ—è.', opts: ['–í–∞—Å–∏–ª—å –°—Ç—É—Å','–õ—ñ–Ω–∞ –ö–æ—Å—Ç–µ–Ω–∫–æ','–û–∫—Å–∞–Ω–∞ –ó–∞–±—É–∂–∫–æ'], correct: 0, hint: '–ü–æ–µ—Ç-—à—ñ—Å—Ç–¥–µ—Å—è—Ç–Ω–∏–∫, –ø—Ä–∞–≤–æ–∑–∞—Ö–∏—Å–Ω–∏–∫.', explain: '–°—Ç—É—Å ‚Äî –ø—Ä–æ —Å–∏–ª—É –ø–æ–µ—Ç–∏—á–Ω–æ–≥–æ —Å–ª–æ–≤–∞.', context: '' },
    ];

    let tasks = JSON.parse(JSON.stringify(TASKS_QUOTES_BASE));
    let idx = 0; let right = 0; let wrong = 0; let startedAt = null;
    let perTaskTimer = null; let leftSec = 45;
    const stateKey = 'mf-quest-who-v1';

    const totalCountEl = document.getElementById('totalCount');
    const progressChipEl = document.getElementById('progressChip');
    const progressBarEl = document.getElementById('progressBar');
    const taskCounterEl = document.getElementById('taskCounter');
    const quoteTextEl = document.getElementById('quoteText');
    const optionsBoxEl = document.getElementById('optionsBox');
    const hintBtn = document.getElementById('hintBtn');
    const checkBtn = document.getElementById('checkBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const hintBox = document.getElementById('hintBox');
    const explainBox = document.getElementById('explainBox');
    const contextBox = document.getElementById('contextBox');
    const shuffleToggle = document.getElementById('shuffleToggle');
    const timedToggle = document.getElementById('timedToggle');
    const hintModeToggle = document.getElementById('hintModeToggle');
    const timerEl = document.getElementById('timer');
    const timerBox = document.getElementById('timerBox');
    const restartBtn = document.getElementById('restartBtn');
    const saveLink = document.getElementById('saveLink');
    const toastEl = document.getElementById('toast');
    let toastTimer = null;

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    const fmtTime = (ms)=>{ const sec=Math.round(ms/1000); const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; };

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toastEl.classList.remove('show'); }, 2500);
    }

    function saveState(){
      const state = {idx,right,wrong,tasks,startedAt: startedAt?.valueOf?.()||Date.now(), timed: timedToggle.checked, hintOn: hintModeToggle.checked, shuffle: shuffleToggle.checked};
      localStorage.setItem(stateKey, JSON.stringify(state));
    }
    function loadState(){
      const raw = localStorage.getItem(stateKey);
      if(!raw) return false;
      try{
        const s = JSON.parse(raw);
        if(!s || !Array.isArray(s.tasks)) return false;
        tasks = s.tasks; idx = s.idx||0; right = s.right||0; wrong = s.wrong||0; startedAt = new Date(s.startedAt||Date.now());
        timedToggle.checked = !!s.timed; timerBox.classList.toggle('hidden', !timedToggle.checked);
        hintModeToggle.checked = s.hintOn!==false; 
        shuffleToggle.checked = !!s.shuffle; 
        return true;
      }catch(e){ return false; }
    }

    function resetAll(){
      tasks = JSON.parse(JSON.stringify(TASKS_QUOTES_BASE));
      if(shuffleToggle.checked) shuffle(tasks);
      idx = 0; right = 0; wrong = 0; startedAt = new Date();
      clearInterval(perTaskTimer); leftSec = 45; timerEl.textContent = leftSec;
      timerBox.classList.toggle('hidden', !timedToggle.checked);
      hintBtn.disabled = !hintModeToggle.checked;
      hintBtn.style.display = hintModeToggle.checked ? 'inline-flex' : 'none';
      render(); saveState();
    }

    function startPerTaskTimer(){
      clearInterval(perTaskTimer);
      if(!timedToggle.checked) return;
      leftSec = 45; timerEl.textContent = leftSec;
      perTaskTimer = setInterval(()=>{
        leftSec--; timerEl.textContent = leftSec;
        if(leftSec<=0){
          clearInterval(perTaskTimer);
          lockOptions();
          revealAnswer(false, true);
        }
      },1000);
    }

    function lockOptions(){ 
      optionsBoxEl.querySelectorAll('button.opt').forEach(b=>b.disabled=true); 
      checkBtn.disabled = true; hintBtn.disabled = true; skipBtn.disabled = true; 
    }
    function unlockOptions(){ 
      optionsBoxEl.querySelectorAll('button.opt').forEach(b=>b.disabled=false); 
      checkBtn.disabled = false; hintBtn.disabled = !hintModeToggle.checked; skipBtn.disabled = false; 
    }

    function render(){
      totalCountEl.textContent = tasks.length;
      progressChipEl.textContent = `${Math.min(idx, tasks.length)}/${tasks.length}`;
      progressBarEl.style.width = `${(Math.min(idx,tasks.length)/tasks.length)*100}%`;
      taskCounterEl.textContent = `–¶–∏—Ç–∞—Ç–∞ ${Math.min(idx+1,tasks.length)}/${tasks.length}`;

      hintBox.classList.add('hidden'); hintBox.textContent='';
      explainBox.classList.add('hidden'); explainBox.textContent='';
      contextBox.classList.add('hidden'); contextBox.textContent='';
      nextBtn.disabled = true;

      if(idx>=tasks.length){ showResults(); return; }

      const t = tasks[idx];
      quoteTextEl.textContent = t.quote;
      optionsBoxEl.innerHTML = '';
      t.opts.forEach((opt,i)=>{ 
        const btn = document.createElement('button');
        btn.className = 'opt text-left'; btn.type='button'; btn.setAttribute('data-i', i);
        btn.innerHTML = `<span class=\"kbd\">${String.fromCharCode(65+i)}</span> <span>${opt}</span>`;
        btn.addEventListener('click', ()=>selectOption(i));
        btn.setAttribute('aria-label', `–í–∞—Ä—ñ–∞–Ω—Ç ${String.fromCharCode(65+i)}: ${opt}`);
        optionsBoxEl.appendChild(btn);
      });
      chosen = null;
      unlockOptions();
      startPerTaskTimer();
    }

    let chosen = null;
    function selectOption(i){
      chosen = i;
      optionsBoxEl.querySelectorAll('.opt').forEach(b=>b.classList.remove('ring-2','ring-[var(--blue)]'));
      const current = optionsBoxEl.querySelector(`.opt[data-i=\"${i}\"]`);
      if(current) current.classList.add('ring-2','ring-[var(--blue)]');
    }

    function revealAnswer(isManualCheck=true, dueToTimer=false){
      const t = tasks[idx];
      const correct = t.correct;
      optionsBoxEl.querySelectorAll('.opt').forEach((b)=>{
        const i = Number(b.getAttribute('data-i'));
        if(i===correct) b.classList.add('correct');
        if(chosen!==null && i===chosen && chosen!==correct) b.classList.add('wrong');
      });

      const ok = (chosen===correct) && !dueToTimer;
      if(ok){ right++; explainBox.className = 'mt-3 text-sm bg-green-50 border border-green-200 text-green-900 rounded-lg p-3'; }
      else { wrong++; explainBox.className = 'mt-3 text-sm bg-red-50 border border-red-200 text-red-900 rounded-lg p-3'; }

      hintBox.classList.add('hidden');
      explainBox.classList.remove('hidden');
      explainBox.innerHTML = ok ? `<b class=\"text-lg\">–°–∞–º–µ —Ç–∞–∫! –ê–≤—Ç–æ—Ä ‚Äî ${t.opts[correct]}.</b>` : `<b class=\"text-lg\">–ù–∞—Å–ø—Ä–∞–≤–¥—ñ —Ü–µ —Å–∫–∞–∑–∞–≤(–ª–∞) ${t.opts[correct]}.</b>`;
      if(t.explain) explainBox.innerHTML += ` <div class=\"mt-1\">${t.explain}</div>`;
      if(t.context){ contextBox.classList.remove('hidden'); contextBox.textContent = '–ö–æ–Ω—Ç–µ–∫—Å—Ç: ' + t.context; }
      if(dueToTimer) explainBox.innerHTML += ' <div class=\"mt-1 font-semibold\">(–ß–∞—Å –≤–∏—á–µ—Ä–ø–∞–Ω–æ)</div>';

      nextBtn.disabled = false; lockOptions(); saveState();
    }

    hintBtn.addEventListener('click', ()=>{ if(!hintModeToggle.checked) return; const t = tasks[idx]; hintBox.classList.remove('hidden'); hintBox.textContent = t.hint||'–ü–æ–¥—É–º–∞–π –ø—Ä–æ –¥–æ–±—É —Ç–∞ –∫–æ–ª–æ –∞–≤—Ç–æ—Ä–∞.'; });
    checkBtn.addEventListener('click', ()=>{ if(chosen===null){ optionsBoxEl.classList.add('shake'); showToast('–û–±–µ—Ä—ñ—Ç—å –≤–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.'); setTimeout(()=>optionsBoxEl.classList.remove('shake'),500); return; } clearInterval(perTaskTimer); revealAnswer(true,false); });
    nextBtn.addEventListener('click', ()=>{ idx++; render(); saveState(); });
    skipBtn.addEventListener('click', ()=>{ wrong++; idx++; render(); saveState(); });
    restartBtn.addEventListener('click', ()=>{ localStorage.removeItem(stateKey); resetAll(); });
    saveLink?.addEventListener('click', (e)=>{ e.preventDefault(); saveState(); showToast('–ü—Ä–æ–≥—Ä–µ—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ.'); });

    function showResults(){
      const total = tasks.length; const ms = Date.now()-startedAt.valueOf();
      const resRightEl = document.getElementById('resRight');
      const resWrongEl = document.getElementById('resWrong');
      const resTimeEl = document.getElementById('resTime');
      const badgeBox = document.getElementById('badgeBox');
      const resTip = document.getElementById('resTip');
      resRightEl.textContent = right; resWrongEl.textContent = wrong; resTimeEl.textContent = fmtTime(ms);
      badgeBox.innerHTML = '';
      const rate = total > 0 ? right/total : 0;
      const badges = [];
      if(rate===1) badges.push({name:'–ú–æ–≤–æ–∑–Ω–∞–≤–µ—Ü—å', desc:'–ñ–æ–¥–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏ ‚Äî –±–ª–∏—Å–∫—É—á–µ!'});
      else if(rate>=0.8) badges.push({name:'–¶–∏—Ç–∞—Ç–æ–∑–Ω–∞–≤–µ—Ü—å', desc:'–í–ø–µ–≤–Ω–µ–Ω–µ –≤—ñ–¥—á—É—Ç—Ç—è –∞–≤—Ç–æ—Ä—ñ–≤.'});
      else if(rate>=0.6) badges.push({name:'–î–æ—Å–ª—ñ–¥–Ω–∏–∫ –º–æ–≤–∏', desc:'–ì–∞—Ä–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Ä—É—Ö–∞–π—Å—è –¥–∞–ª—ñ!'});
      else badges.push({name:'–ü–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å', desc:'–ß–∞—Å –ø–æ–¥—Ä—É–∂–∏—Ç–∏—Å—è –∑ –∞–≤—Ç–æ—Ä–∞–º–∏ –±–ª–∏–∂—á–µ.'});
      badges.forEach(b=>{ const el = document.createElement('div'); el.className='card p-3 bg-gray-50'; el.innerHTML=`<div class=\"font-semibold text-lg\">üèÖ ${b.name}</div><div class=\"text-sm text-[var(--muted)]\">${b.desc}</div>`; badgeBox.appendChild(el); });
      resTip.textContent = rate<0.8 ? '–ü–æ—Ä–∞–¥–∞: –ø–µ—Ä–µ—á–∏—Ç–∞–π –¥–æ–±—ñ—Ä–∫—É —Ü–∏—Ç–∞—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –º–∏—Å–ª–∏—Ç–µ–ª—ñ–≤ —ñ –ø–∏—Å—å–º–µ–Ω–Ω–∏–∫—ñ–≤.' : '–ß—É–¥–æ–≤–æ! –°–ø—Ä–æ–±—É–π –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –ø—ñ–¥–∫–∞–∑–æ–∫ —ñ –∑ —Ç–∞–π–º–µ—Ä–æ–º.';
      document.getElementById('resultModal').showModal();
    }

    document.getElementById('closeModalBtn').addEventListener('click', () => { document.getElementById('resultModal').close(); });
    document.getElementById('restartModalBtn').addEventListener('click', () => { document.getElementById('resultModal').close(); localStorage.removeItem(stateKey); resetAll(); });

    (function selfTests(){
      try {
        console.assert(Array.isArray(TASKS_QUOTES_BASE) && TASKS_QUOTES_BASE.length >= 10, '[Test] –ú–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 10 —Ü–∏—Ç–∞—Ç');
        const hasKulish = TASKS_QUOTES_BASE.some(t=>t.quote.includes('–ú–æ–≤–∞ ‚Äî —Ü–µ –¥—É—à–∞ –Ω–∞—Ä–æ–¥—É.') && t.opts[0].includes('–ö—É–ª—ñ—à'));
        const hasFranko = TASKS_QUOTES_BASE.some(t=>t.quote.includes('–£ –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞ —Å–≤–æ—è –¥–æ–ª—è.') && t.opts.includes('–Ü–≤–∞–Ω –§—Ä–∞–Ω–∫–æ'));
        console.assert(hasKulish && hasFranko, '[Test] –ü—Ä–∏–∫–ª–∞–¥–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ');
        const t0 = TASKS_QUOTES_BASE[0];
        console.assert(typeof t0.quote==='string' && Array.isArray(t0.opts) && Number.isInteger(t0.correct), '[Test] –§–æ—Ä–º–∞—Ç –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∞–ª—ñ–¥–Ω–∏–π');
        console.log('[SelfTests] OK');
      } catch (e) { console.error('[SelfTests] FAILED', e); }
    })();

    (function init(){
      shuffleToggle.addEventListener('change', () => { resetAll(); });
      timedToggle.addEventListener('change', () => {
        timerBox.classList.toggle('hidden', !timedToggle.checked);
        if (timedToggle.checked && idx < tasks.length && checkBtn.disabled === false) { startPerTaskTimer(); } else { clearInterval(perTaskTimer); }
        saveState();
      });
      hintModeToggle.addEventListener('change', () => {
        const hintsEnabled = hintModeToggle.checked; 
        hintBtn.style.display = hintsEnabled ? 'inline-flex' : 'none';
        hintBtn.disabled = !hintsEnabled;
        if (!hintsEnabled) { hintBox.classList.add('hidden'); }
        saveState();
      });

      const restored = loadState();
      if(!restored){ resetAll(); }
      else { hintBtn.style.display = hintModeToggle.checked ? 'inline-flex' : 'none'; render(); if (timedToggle.checked && idx < tasks.length && checkBtn.disabled === false) { startPerTaskTimer(); } }
    })();
  </script>
</body>
</html>
