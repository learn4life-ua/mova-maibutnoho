<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–≤–µ—Å—Ç ¬´–°–ª–æ–≤–æ-—Ä—è—Ç—ñ–≤–Ω–∏–∫¬ª ‚Äî –ú–æ–≤–∞ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ</title>
  <meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –∫–≤–µ—Å—Ç –¥–ª—è –ø–æ—Ä—è—Ç—É–Ω–∫—É –º–æ–≤–∏ –≤—ñ–¥ –∑–∞–ø–æ–∑–∏—á–µ–Ω—å. –ó–∞–º—ñ–Ω–∏ —ñ–Ω—à–æ–º–æ–≤–Ω–µ —Å–ª–æ–≤–æ –ø–∏—Ç–æ–º–∏–º —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–º." />
  <meta name="color-scheme" content="light" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* --- –ó–ú–Ü–ù–ù–Ü –¢–ê –ë–ê–ó–û–í–Ü –°–¢–ò–õ–Ü --- */
    :root {
      --blue: #4BA3C3; --blue-dark: #1E3A5F; --gray-bg: #F5F7FA;
      --text: #2C2C2C; --muted: #6B7280; --border: #D1D5DB;
      --card-shadow:0 10px 22px rgba(0,0,0,.08);
      --ok:#16a34a; /* —É—Å–ø—ñ—Ö */
      --warn:#ef4444; /* –ø–æ–º–∏–ª–∫–∞ */
    }
    
    /* --- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ —Å—Ç–∏–ª—ñ —à–∞–±–ª–æ–Ω—É --- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', sans-serif; background-color: var(--gray-bg);
      color: var(--text); line-height: 1.7; margin: 0;
      display: flex; flex-direction: column;
    }
    .page-header {
      background: linear-gradient(90deg, var(--blue-dark) 0%, var(--blue) 100%);
      color: #fff; padding: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.10);
      position: sticky; top: 0; z-index: 50;
    }
    .header-nav {
      max-width: 900px; margin: 0 auto; display: flex;
      justify-content: space-between; align-items: center;
    }
    .back-link {
      display: inline-flex; align-items: center; gap: 0.5rem;
      color: #fff; text-decoration: none; font-weight: 600;
      font-size: 0.95rem; transition: opacity 0.2s ease;
    }
    .back-link:hover { opacity: 0.85; }
    .back-link svg { width: 20px; height: 20px; }
    .guidebook-title {
      font-size: 0.9rem; opacity: 0.9;
    }
    @media (max-width: 640px) {
      .guidebook-title { display: none; }
    }
    
    /* –°–¢–ò–õ–Ü –û–°–ù–û–í–ù–û–ì–û –ö–û–ù–¢–ï–ù–¢–£ */
    .main-content {
      flex-grow: 1; max-width: 900px; width: 100%;
      margin: 1.5rem auto; padding: 0 1rem;
    }
    .content-wrapper {
      background: #fff; border-radius: 1rem; padding: 2rem 2.5rem;
      border: 1px solid var(--border); box-shadow: 0 6px 14px rgba(0, 0, 0, 0.05);
    }
    @media (max-width: 640px) {
      .content-wrapper { padding: 1.5rem; }
    }
    .content-wrapper h1 {
      font-size: clamp(1.6rem, 2.5vw + 1rem, 2.25rem); font-weight: 700;
      color: var(--blue-dark); margin-top: 0; margin-bottom: 1rem; line-height: 1.3;
      text-align: center;
    }
    .content-wrapper h2 {
      font-size: 1.4rem; font-weight: 600; color: var(--blue-dark);
      margin-top: 1.8rem; margin-bottom: 0.8rem;
    }
    .content-wrapper p {
      margin-top: 0; margin-bottom: 1.5rem; font-size: 1.05rem;
      color: var(--text);
    }
    .content-wrapper strong { font-weight: 600; color: var(--text); }
    footer { 
      text-align: center; padding: 1.5rem 1rem; font-size: 0.9rem;
      color: var(--muted); background: #fff; border-top: 1px solid var(--border);
      margin-top: auto;
    }
    
    /* --- –°—Ç–∏–ª—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ –∫–≤–µ—Å—Ç—É --- */
    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .7rem;border-radius:999px;border:1px solid var(--border);background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.7rem 1rem;border-radius:.9rem;border:1px solid var(--border);transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--blue);color:#fff;border-color:var(--blue)}
    .btn-primary:disabled{opacity:.6}
    .btn-ghost{background:#fff}

    /* –°–¢–ò–õ–¨ –ö–ù–û–ü–ö–ò –Ü–ù–í–ï–†–°–Ü–á */
    .invert-btn.tab-active {
        background: var(--blue);
        color: #fff;
        border-color: var(--blue);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .invert-btn.tab-active:hover {
        filter: brightness(1.1);
    }

    .opt{border:1px solid var(--border);border-radius:.9rem;padding:1rem;background:#fff;cursor:pointer;display:flex;gap:.8rem;align-items:flex-start}
    .opt:hover{border-color:var(--blue)}
    .opt.correct{border-color:var(--ok);box-shadow:0 0 0 3px rgba(22,163,74,.15)}
    .opt.wrong{border-color:var(--warn);box-shadow:0 0 0 3px rgba(239,68,68,.12)}
    
    /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–Ω—è –ª—ñ—Ç–µ—Ä —É –≤–∞—Ä—ñ–∞–Ω—Ç–∞—Ö */
    .kbd{display:none;}
    
    /* –°–¢–ò–õ–Ü –î–õ–Ø –ù–û–í–û–ì–û –ö–í–ï–°–¢–£ (–°–ª–æ–≤–æ-—Ä—è—Ç—ñ–≤–Ω–∏–∫) */
    b.borrowed {
      color: var(--blue-dark);
      font-weight: 700;
      background: #eff6ff;
      padding: 2px 5px;
      border-radius: 5px;
      border: 1px solid #bfdbfe;
    }
    .explain-block {
      display: grid;
      grid-template-columns: 45px 1fr;
      gap: 4px 8px;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    .explain-block span {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .explain-sentence {
      font-size: 1rem;
      line-height: 1.6;
    }
    .answer-inline {
      color: var(--ok);
      font-weight: 700;
      border-bottom: 2px solid var(--ok);
      padding-bottom: 1px;
    }
    .bg-red-50 .answer-inline {
        color: var(--warn);
        border-color: var(--warn);
    }
    /* --- –ö—ñ–Ω–µ—Ü—å –Ω–æ–≤–∏—Ö —Å—Ç–∏–ª—ñ–≤ --- */
    
    dialog::backdrop{background:rgba(0,0,0,.45)}
    dialog{border:none;border-radius:1rem;max-width:680px;width:92%;padding:0;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .modal-body{padding:1.25rem}
    
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    .shake { animation: shake 0.5s ease-in-out; }

    #toast {
      display: none; /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–æ: –±—ñ–ª—å—à–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è */
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">
  
  <header class="page-header">
    <nav class="header-nav">
      <!-- –ü–æ—Å–∏–ª–∞–Ω–Ω—è "–ù–∞ –≥–æ–ª–æ–≤–Ω—É" –∑ –≤–∞—à–∏–º URL -->
      <a href="https://learn4life-ua.github.io/mova-maibutnoho" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        –ù–∞ –≥–æ–ª–æ–≤–Ω—É
      </a>
      <div class="guidebook-title">
        –ü–æ—Å—ñ–±–Ω–∏–∫: <strong>–ú–æ–≤–∞ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ</strong>
      </div>
    </nav>
  </header>

  <main class="main-content">
    <div class="content-wrapper">

      <h1>–ö–≤–µ—Å—Ç ¬´–°–ª–æ–≤–æ-—Ä—è—Ç—ñ–≤–Ω–∏–∫¬ª</h1>
      <p class="text-center max-w-lg mx-auto mb-6">–ó–∞–º—ñ–Ω–∏ –∑–∞–ø–æ–∑–∏—á–µ–Ω–Ω—è –ø–∏—Ç–æ–º–∏–º —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–º —Å–ª–æ–≤–æ–º. –†—è—Ç—É–π–º–æ –º–æ–≤—É —Ä–∞–∑–æ–º!</p>

      <section class="mb-6">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
          <div class="flex flex-wrap items-center gap-3">
            <span class="chip" title="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–≤–¥–∞–Ω—å"><strong class="font-semibold" id="totalCount">‚Äî</strong> –∑–∞–≤–¥–∞–Ω—å</span>
            <span class="chip" title="–†—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ"><span id="levelLabel">–í–∏—Å–æ–∫–∏–π</span></span>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <label class="flex items-center gap-2 text-sm"><input id="shuffleToggle" type="checkbox" class="h-4 w-4"> –ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏</label>
            <button id="invertBtn" class="btn invert-btn" title="–Ü–Ω–≤–µ—Ä—Å—ñ—è: –£–∫—Ä. ‚Üí –ó–∞–ø–æ–∑–∏—á–µ–Ω–Ω—è">‚áÖ –Ü–Ω–≤–µ—Ä—Å—ñ—è</button>
            <label class="flex items-center gap-2 text-sm"><input id="timedToggle" type="checkbox" class="h-4 w-4"> –¢–∞–π–º–µ—Ä 60—Å/–∑–∞–≤–¥.</label>
            <button id="restartBtn" class="btn" title="–ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ">‚ü≤ –ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
          </div>
        </div>
        <!-- –ü–†–û–ì–†–ï–° –ë–ê–† –í–ò–î–ê–õ–ï–ù–û -->
      </section>

      <section id="taskArea" aria-live="polite">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-sm text-[var(--muted)]" id="taskCounter">–ó–∞–≤–¥–∞–Ω–Ω—è 1/‚Äî</div>
            <h2 class="text-xl md:text-2xl font-semibold mt-1" id="taskTitle">–û–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–∫</h2>
          </div>
          <div class="text-right">
            <div id="timerBox" class="hidden text-sm"><span class="font-semibold">–¢–∞–π–º–µ—Ä:</span> <span id="timer">60</span> —Å</div>
          </div>
        </div>

        <div class="mt-4 p-4 bg-[#f9fafb] rounded-xl border border-[var(--border)]" id="promptBox">
          <p class="text-lg" id="promptText">‚Ä¶</p>
        </div>

        <div class="mt-4 grid gap-3" id="optionsBox" role="group" aria-label="–í–∞—Ä—ñ–∞–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ"></div>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <button id="hintBtn" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É (H)">üí° –ü—ñ–¥–∫–∞–∑–∫–∞</button>
          <button id="checkBtn" class="btn btn-primary" title="–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (Enter)">‚úî –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
          <button id="nextBtn" class="btn" title="–ù–∞—Å—Ç—É–ø–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è (N)" disabled>‚Üí –î–∞–ª—ñ</button>
          <button id="skipBtn" class="btn" title="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è (S)">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
        </div>

        <div id="hintBox" class="mt-3 hidden text-sm bg-blue-50 border border-blue-200 text-blue-900 rounded-lg p-3"></div>
        <div id="explainBox" class="mt-3 hidden text-sm bg-green-50 border border-green-200 text-green-900 rounded-lg p-3"></div>
      </section>

      <section class="text-sm text-[var(--muted)] mt-4 flex items-center justify-between border-t border-[var(--border)] pt-4">
        <!-- –ì–ê–†–Ø–ß–Ü –ö–õ–ê–í–Ü–®–Ü-–ë–£–ö–í–ò –í–ò–î–ê–õ–ï–ù–û -->
        <div>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å <span class="kbd">H</span> ‚Äî –ø—ñ–¥–∫–∞–∑–∫–∞, <span class="kbd">Enter</span> ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, <span class="kbd">N</span> ‚Äî –¥–∞–ª—ñ, <span class="kbd">S</span> ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏.</div>
        <!-- –ö–ù–û–ü–ö–ê –ó–ë–ï–†–ï–ì–¢–ò –ü–†–û–ì–†–ï–° –í–ò–î–ê–õ–ï–ù–ê -->
      </section>

    </div>
  </main>

  <footer>
    ¬© 2025 –í–°–ü ¬´–ê–≥—Ä–∞—Ä–Ω–æ-–µ–∫–æ–Ω–æ–º—ñ—á–Ω–∏–π —Ñ–∞—Ö–æ–≤–∏–π –∫–æ–ª–µ–¥–∂ –ü–î–ê–£¬ª. –ü—Ä–æ—î–∫—Ç ¬´–ú–æ–≤–∞ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ¬ª.
  </footer>

  <dialog id="resultModal">
    <div class="bg-[var(--blue-dark)] text-white rounded-t-[1rem] p-5">
      <h3 class="text-xl font-semibold">–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–≤–µ—Å—Ç—É</h3>
      <p class="opacity-90 text-sm">–ü—ñ–¥—Å—É–º–æ–∫ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞—Ä–æ–±–ª–µ–Ω—ñ –±–µ–π–¥–∂—ñ</p>
    </div>
    <div class="modal-body">
      <div class="grid gap-3">
        <div class="flex flex-wrap items-center gap-3">
          <span class="chip"><strong>–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö:</strong> <span id="resRight">0</span></span>
          <span class="chip"><strong>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö:</strong> <span id="resWrong">0</span></span>
          <span class="chip"><strong>–ß–∞—Å:</strong> <span id="resTime">‚Äî</span></span>
        </div>
        <div class="mt-2 grid md:grid-cols-2 gap-3" id="badgeBox"></div>
        <div class="mt-2 text-sm text-[var(--muted)]" id="resTip"></div>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4 p-3 border-t">
        <button class="btn" id="closeModalBtn">–ì–∞—Ä–∞–∑–¥</button>
        <button class="btn btn-primary" id="restartModalBtn">–ü—Ä–æ–π—Ç–∏ —â–µ —Ä–∞–∑</button>
      </div>
    </div>
  </dialog>

  <!-- –ï–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–æ—Å—Ç-—Å–ø–æ–≤—ñ—â–µ–Ω—å (–∑–∞–ª–∏—à–∞—î–º–æ –ª–∏—à–µ –¥–ª—è –ø–æ–∫–∞–∑—É –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ) -->
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    /**
     * (–û–ù–û–í–õ–ï–ù–û) –î–ê–ù–Ü –ö–í–ï–°–¢–£ "–°–õ–û–í–û-–†–Ø–¢–Ü–í–ù–ò–ö"
     */
    const TASKS_BASE = [
      {
        s: '–ù–∞—à <b class="borrowed">–±—Ä–µ–Ω–¥</b> —É–ø—ñ–∑–Ω–∞–≤–∞–Ω–∏–π —Å–µ—Ä–µ–¥ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤.', 
        opts: ['—Ç–æ—Ä–≥–æ–≤–∞ –º–∞—Ä–∫–∞', '–º–∞—Ä–∫–∞', '–ª–æ–≥–æ—Ç–∏–ø'], // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É
        correct: 1, // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É (–º–∞—Ä–∫–∞)
        hint: '–ö–æ—Ä–æ—Ç—à–∏–π –ø–∏—Ç–æ–º–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–∫.',
        explain: '¬´–ë—Ä–µ–Ω–¥¬ª ‚Üí ¬´–º–∞—Ä–∫–∞¬ª (—Ç–∞–∫–æ–∂ ¬´—Ç–æ—Ä–≥–æ–≤–∞ –º–∞—Ä–∫–∞¬ª).',
        rewrite: '–ù–∞—à–∞ <span class="answer-inline">–º–∞—Ä–∫–∞</span> –≤–ø—ñ–∑–Ω–∞–≤–∞–Ω–∞ —Å–µ—Ä–µ–¥ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤.',
        s_inv: '–ù–∞—à–∞ <b class="borrowed">–º–∞—Ä–∫–∞</b> –≤–ø—ñ–∑–Ω–∞–≤–∞–Ω–∞ —Å–µ—Ä–µ–¥ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤.',
        opts_inv: ['–±—Ä–µ–Ω–¥', '–ª–µ–π–±–ª', '—Ñ—ñ—Ä–º–∞—á'],
        correct_inv: 0,
        hint_inv: '–®—É–∫–∞—î–º–æ –ø–æ–ø—É–ª—è—Ä–Ω–∏–π –∞–Ω–≥–ª—ñ—Ü–∏–∑–º.',
        explain_inv: '¬´–ú–∞—Ä–∫–∞¬ª ‚Üí ¬´–±—Ä–µ–Ω–¥¬ª.',
        rewrite_inv: '–ù–∞—à <span class="answer-inline">–±—Ä–µ–Ω–¥</span> —É–ø—ñ–∑–Ω–∞–≤–∞–Ω–∏–π —Å–µ—Ä–µ–¥ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤.'
      },
      {
        s: '–ú–∏ –ø—Ä–æ–≤–µ–ª–∏ <b class="borrowed">–±—Ä–∏—Ñ—ñ–Ω–≥</b> –¥–ª—è –≤–æ–ª–æ–Ω—Ç–µ—Ä—ñ–≤.', 
        opts: ['–º—ñ—Ç–∏–Ω–≥', '—ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂', '–∫–æ—Ä–æ—Ç–∫–∞ –Ω–∞—Ä–∞–¥–∞'], // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É
        correct: 2, // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É (–∫–æ—Ä–æ—Ç–∫–∞ –Ω–∞—Ä–∞–¥–∞)
        hint: '–ö–æ—Ä–æ—Ç–∫–∞ –Ω–∞—Ä–∞–¥–∞-—ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂.',
        explain: '¬´–ë—Ä–∏—Ñ—ñ–Ω–≥¬ª ‚Üí ¬´–∫–æ—Ä–æ—Ç–∫–∞ –Ω–∞—Ä–∞–¥–∞¬ª (—Ç–∞–∫–æ–∂ ¬´—ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂¬ª).',
        rewrite: '–ú–∏ –ø—Ä–æ–≤–µ–ª–∏ <span class="answer-inline">–∫–æ—Ä–æ—Ç–∫—É –Ω–∞—Ä–∞–¥—É</span> –¥–ª—è –≤–æ–ª–æ–Ω—Ç–µ—Ä—ñ–≤.',
        s_inv: '–ú–∏ –ø—Ä–æ–≤–µ–ª–∏ <b class="borrowed">–∫–æ—Ä–æ—Ç–∫—É –Ω–∞—Ä–∞–¥—É</b> –¥–ª—è –≤–æ–ª–æ–Ω—Ç–µ—Ä—ñ–≤.',
        opts_inv: ['–±—Ä–∏—Ñ—ñ–Ω–≥', '–º—ñ—Ç–∏–Ω–≥', '–∫–æ–º—ñ—Ç–µ—Ç'],
        correct_inv: 0,
        hint_inv: '–ó–∞–ø–æ–∑–∏—á–µ–Ω–Ω—è, —â–æ –æ–∑–Ω–∞—á–∞—î –∫–æ—Ä–æ—Ç–∫—ñ –∑–±–æ—Ä–∏.',
        explain_inv: '¬´–ö–æ—Ä–æ—Ç–∫–∞ –Ω–∞—Ä–∞–¥–∞¬ª ‚Üí ¬´–±—Ä–∏—Ñ—ñ–Ω–≥¬ª.',
        rewrite_inv: '–ú–∏ –ø—Ä–æ–≤–µ–ª–∏ <span class="answer-inline">–±—Ä–∏—Ñ—ñ–Ω–≥</span> –¥–ª—è –≤–æ–ª–æ–Ω—Ç–µ—Ä—ñ–≤.'
      },
      {
        s: '–Ø–∫–∏–π <b class="borrowed">–¥–µ–¥–ª–∞–π–Ω</b> —Ü—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è?',
        opts: ['—Ä–µ—á–µ–Ω–µ—Ü—å', '–∫—ñ–Ω—Ü–µ–≤–∞ –¥–∞—Ç–∞', '—Ñ—ñ–Ω—ñ—à'], // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É
        correct: 0, // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É (—Ä–µ—á–µ–Ω–µ—Ü—å)
        hint: '–ß–∞—Å, –¥–æ —è–∫–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç–∏.',
        explain: '¬´–î–µ–¥–ª–∞–π–Ω¬ª ‚Üí ¬´—Ä–µ—á–µ–Ω–µ—Ü—å¬ª (—Ç–∞–∫–æ–∂ ¬´–∫—Ä–∞–π–Ω—ñ–π —Ç–µ—Ä–º—ñ–Ω¬ª).',
        rewrite: '–Ø–∫–∏–π <span class="answer-inline">—Ä–µ—á–µ–Ω–µ—Ü—å</span> —Ü—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è?',
        s_inv: '–Ø–∫–∏–π <b class="borrowed">—Ä–µ—á–µ–Ω–µ—Ü—å</b> —Ü—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è?',
        opts_inv: ['–¥–µ–¥–ª–∞–π–Ω', '—Ñ—ñ–Ω–∞–ª', '—Å—Ç–æ–ø-—á–∞—Å'],
        correct_inv: 0,
        hint_inv: '–ê–Ω–≥–ª—ñ—Ü–∏–∑–º, —â–æ –æ–∑–Ω–∞—á–∞—î –∫—ñ–Ω–µ—Ü—å —Å—Ç—Ä–æ–∫—É.',
        explain_inv: '¬´–†–µ—á–µ–Ω–µ—Ü—å¬ª ‚Üí ¬´–¥–µ–¥–ª–∞–π–Ω¬ª.',
        rewrite_inv: '–Ø–∫–∏–π <span class="answer-inline">–¥–µ–¥–ª–∞–π–Ω</span> —Ü—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è?'
      },
      {
        s: '–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ <b class="borrowed">—é–∑–∞–±—ñ–ª—ñ—Ç—ñ</b> —Å–∞–π—Ç—É.',
        opts: ['–∑—Ä—É—á–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è', '–¥–∏–∑–∞–π–Ω', '–≤–∏–≥–ª—è–¥'],
        correct: 0,
        hint: '–ù–∞—Å–∫—ñ–ª—å–∫–∏ –∑—Ä—É—á–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è?',
        explain: '¬´–Æ–∑–∞–±—ñ–ª—ñ—Ç—ñ¬ª ‚Üí ¬´–∑—Ä—É—á–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è¬ª.',
        rewrite: '–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ <span class="answer-inline">–∑—Ä—É—á–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è</span> —Å–∞–π—Ç–æ–º.',
        s_inv: '–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ <b class="borrowed">–∑—Ä—É—á–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è</b> —Å–∞–π—Ç–æ–º.',
        opts_inv: ['—é–∑–∞–±—ñ–ª—ñ—Ç—ñ', 'UX', '—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å'],
        correct_inv: 0,
        hint_inv: '–ê–Ω–≥–ª—ñ—Ü–∏–∑–º, —Å–∏–Ω–æ–Ω—ñ–º –¥–æ "UX".',
        explain_inv: '¬´–ó—Ä—É—á–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è¬ª ‚Üí ¬´—é–∑–∞–±—ñ–ª—ñ—Ç—ñ¬ª.',
        rewrite_inv: '–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ <span class="answer-inline">—é–∑–∞–±—ñ–ª—ñ—Ç—ñ</span> —Å–∞–π—Ç—É.'
      },
      {
        s: '–ú–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–π <b class="borrowed">—Ñ—ñ–¥–±–µ–∫</b>.',
        opts: ['–≤—ñ–¥–≥—É–∫', '–∑–≤–æ—Ä–æ—Ç–Ω–∏–π –∑–≤‚Äô—è–∑–æ–∫', '—Ä–µ—Å–ø–æ–Ω—Å'], // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É
        correct: 0, // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É (–≤—ñ–¥–≥—É–∫)
        hint: '–†–µ–∞–∫—Ü—ñ—è –Ω–∞ –¥—ñ—é.',
        explain: '¬´–§—ñ–¥–±–µ–∫¬ª ‚Üí ¬´–≤—ñ–¥–≥—É–∫¬ª (—Ç–∞–∫–æ–∂ ¬´–≤—ñ–¥–ø–æ–≤—ñ–¥—å¬ª).',
        rewrite: '–ú–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–π <span class="answer-inline">–≤—ñ–¥–≥—É–∫</span>.',
        s_inv: '–ú–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–π <b class="borrowed">–≤—ñ–¥–≥—É–∫</b>.',
        opts_inv: ['—Ñ—ñ–¥–±–µ–∫', '–∫–æ–º–µ–Ω—Ç–∞—Ä', '–≤—ñ–¥–ø–æ–≤—ñ–¥—å'],
        correct_inv: 0,
        hint_inv: '–ê–Ω–≥–ª—ñ—Ü–∏–∑–º –¥–ª—è ¬´–∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó¬ª.',
        explain_inv: '¬´–í—ñ–¥–≥—É–∫¬ª ‚Üí ¬´—Ñ—ñ–¥–±–µ–∫¬ª.',
        rewrite_inv: '–ú–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–π <span class="answer-inline">—Ñ—ñ–¥–±–µ–∫</span>.'
      },
      {
        s: '–¶–µ –±—É–≤ <b class="borrowed">—Ñ–µ–π–∫</b>, –∞ –Ω–µ –Ω–æ–≤–∏–Ω–∞.', 
        opts: ['—Ñ–∞–ª—å—à–∏–≤–∫–∞', '–æ–±–º–∞–Ω', '–ø—ñ–¥—Ä–æ–±–∫–∞'], // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É
        correct: 0, // –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É (—Ñ–∞–ª—å—à–∏–≤–∫–∞)
        hint: '–©–æ—Å—å –Ω–µ —Å–ø—Ä–∞–≤–∂–Ω—î.',
        explain: '¬´–§–µ–π–∫¬ª ‚Üí ¬´—Ñ–∞–ª—å—à–∏–≤–∫–∞¬ª (—Ç–∞–∫–æ–∂ ¬´–ø—ñ–¥—Ä–æ–±–∫–∞¬ª).',
        rewrite: '–¶–µ –±—É–ª–∞ <span class="answer-inline">—Ñ–∞–ª—å—à–∏–≤–∫–∞</span>, –∞ –Ω–µ –Ω–æ–≤–∏–Ω–∞.',
        s_inv: '–¶–µ –±—É–ª–∞ <b class="borrowed">—Ñ–∞–ª—å—à–∏–≤–∫–∞</b>, –∞ –Ω–µ –Ω–æ–≤–∏–Ω–∞.',
        opts_inv: ['—Ñ–µ–π–∫', '—Ñ–∞–ª—å—à', '–æ–±–º–∞–Ω'],
        correct_inv: 0,
        hint_inv: '–ü–æ–ø—É–ª—è—Ä–Ω–∏–π –∞–Ω–≥–ª—ñ—Ü–∏–∑–º –¥–ª—è –Ω–µ–ø—Ä–∞–≤–¥–∏–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.',
        explain_inv: '¬´–§–∞–ª—å—à–∏–≤–∫–∞¬ª ‚Üí ¬´—Ñ–µ–π–∫¬ª.',
        rewrite_inv: '–¶–µ –±—É–≤ <span class="answer-inline">—Ñ–µ–π–∫</span>, –∞ –Ω–µ –Ω–æ–≤–∏–Ω–∞.'
      },
      {
        s: '–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–º–æ <b class="borrowed">—ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—é</b> –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.', 
        opts: ['–≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è', '–≤—Ç—ñ–ª–µ–Ω–Ω—è', '–∑–∞–ø—É—Å–∫'], 
        correct: 0,
        hint: '–ü–æ—á–∞—Ç–æ–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.',
        explain: '¬´–Ü–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è¬ª ‚Üí ¬´–≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è¬ª.',
        rewrite: '–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–º–æ <span class="answer-inline">–≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è</span> –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.',
        s_inv: '–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–º–æ <b class="borrowed">–≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è</b> –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.',
        opts_inv: ['—ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—é', '—ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—é', '—Ä–µ–ª—ñ–∑'],
        correct_inv: 0,
        hint_inv: '–ö–Ω–∏–∂–Ω–µ –∑–∞–ø–æ–∑–∏—á–µ–Ω–Ω—è, –æ–∑–Ω–∞—á–∞—î —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é.',
        explain_inv: '¬´–í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è¬ª ‚Üí ¬´—ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è¬ª.',
        rewrite_inv: '–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–º–æ <span class="answer-inline">—ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—é</span> –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.'
      },
      {
        s: '–°—Ç—É–¥–µ–Ω—Ç–∏ –ª—é–±–ª—è—Ç—å <b class="borrowed">—ñ–≤–µ–Ω—Ç–∏</b> –≤ –∫–æ–ª–µ–¥–∂—ñ.',
        opts: ['–ø–æ–¥—ñ—ó', '–∑–∞—Ö–æ–¥–∏', '–≤–µ—á—ñ—Ä–∫–∏'],
        correct: 1,
        hint: '–û—Ä–≥–∞–Ω—ñ–∑–æ–≤–∞–Ω—ñ –ø–æ–¥—ñ—ó.',
        explain: '¬´–Ü–≤–µ–Ω—Ç¬ª ‚Üí ¬´–∑–∞—Ö—ñ–¥¬ª.',
        rewrite: '–°—Ç—É–¥–µ–Ω—Ç–∏ –ª—é–±–ª—è—Ç—å <span class="answer-inline">–∑–∞—Ö–æ–¥–∏</span> –≤ –∫–æ–ª–µ–¥–∂—ñ.',
        s_inv: '–°—Ç—É–¥–µ–Ω—Ç–∏ –ª—é–±–ª—è—Ç—å <b class="borrowed">–∑–∞—Ö–æ–¥–∏</b> –≤ –∫–æ–ª–µ–¥–∂—ñ.',
        opts_inv: ['—ñ–≤–µ–Ω—Ç–∏', '–ø–∞—Ç—ñ', '—Ñ–µ—Å—Ç–∏–≤–∞–ª—ñ'],
        correct_inv: 0,
        hint_inv: '–ê–Ω–≥–ª—ñ—Ü–∏–∑–º –¥–ª—è ¬´–ø–æ–¥—ñ–π¬ª –∞–±–æ ¬´–∑–∞—Ö–æ–¥—ñ–≤¬ª.',
        explain_inv: '¬´–ó–∞—Ö—ñ–¥¬ª ‚Üí ¬´—ñ–≤–µ–Ω—Ç¬ª.',
        rewrite_inv: '–°—Ç—É–¥–µ–Ω—Ç–∏ –ª—é–±–ª—è—Ç—å <span class="answer-inline">—ñ–≤–µ–Ω—Ç–∏</span> –≤ –∫–æ–ª–µ–¥–∂—ñ.'
      },
      {
        s: '–í—ñ–Ω –∫—Ä—É—Ç–∏–π <b class="borrowed">–∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä</b>.',
        opts: ['—Ä–µ–∫–ª–∞–º–Ω–∏–π –∞–≤—Ç–æ—Ä', '—Ç–µ–∫—Å—Ç–æ–≤–∏–∫', '–ø–∏—Å—å–º–µ–Ω–Ω–∏–∫'],
        correct: 0,
        hint: '–ê–≤—Ç–æ—Ä —Ä–µ–∫–ª–∞–º–Ω–∏—Ö —Ç–µ–∫—Å—Ç—ñ–≤.',
        explain: '¬´–ö–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä¬ª ‚Üí ¬´—Ä–µ–∫–ª–∞–º–Ω–∏–π –∞–≤—Ç–æ—Ä¬ª.',
        rewrite: '–í—ñ–Ω –∫—Ä—É—Ç–∏–π <span class="answer-inline">—Ä–µ–∫–ª–∞–º–Ω–∏–π –∞–≤—Ç–æ—Ä</span>.',
        s_inv: '–í—ñ–Ω –∫—Ä—É—Ç–∏–π <b class="borrowed">—Ä–µ–∫–ª–∞–º–Ω–∏–π –∞–≤—Ç–æ—Ä</b>.',
        opts_inv: ['–∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä', '—Å—Ü–µ–Ω–∞—Ä–∏—Å—Ç', '–∂—É—Ä–Ω–∞–ª—ñ—Å—Ç'],
        correct_inv: 0,
        hint_inv: '–ê–Ω–≥–ª—ñ—Ü–∏–∑–º –¥–ª—è –∞–≤—Ç–æ—Ä–∞ —Ä–µ–∫–ª–∞–º–Ω–∏—Ö —Ç–µ–∫—Å—Ç—ñ–≤.',
        explain_inv: '¬´–†–µ–∫–ª–∞–º–Ω–∏–π –∞–≤—Ç–æ—Ä¬ª ‚Üí ¬´–∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä¬ª.',
        rewrite_inv: '–í—ñ–Ω –∫—Ä—É—Ç–∏–π <span class="answer-inline">–∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä</span>.'
      },
      {
        s: '–¶–µ <b class="borrowed">–∫–∞—Å—Ç–æ–º–Ω–∏–π</b> –¥–∏–∑–∞–π–Ω.',
        opts: ['—ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π', '–æ—Å–æ–±–ª–∏–≤–∏–π', '–∞–≤—Ç–æ—Ä—Å—å–∫–∏–π'],
        correct: 0,
        hint: '–ó—Ä–æ–±–ª–µ–Ω–æ –Ω–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.',
        explain: '¬´–ö–∞—Å—Ç–æ–º–Ω–∏–π¬ª ‚Üí ¬´—ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π¬ª.',
        rewrite: '–¶–µ <span class="answer-inline">—ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π</span> –¥–∏–∑–∞–π–Ω.',
        s_inv: '–¶–µ <b class="borrowed">—ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π</b> –¥–∏–∑–∞–π–Ω.',
        opts_inv: ['–∫–∞—Å—Ç–æ–º–Ω–∏–π', '—É–Ω—ñ–∫–∞–ª—å–Ω–∏–π', '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π'],
        correct_inv: 0,
        hint_inv: '–ê–Ω–≥–ª—ñ—Ü–∏–∑–º –≤—ñ–¥ "custom".',
        explain_inv: '¬´–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π¬ª ‚Üí ¬´–∫–∞—Å—Ç–æ–º–Ω–∏–π¬ª.',
        rewrite_inv: '–¶–µ <span class="answer-inline">–∫–∞—Å—Ç–æ–º–Ω–∏–π</span> –¥–∏–∑–∞–π–Ω.'
      }
    ];

    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è/—Å—Ç–∞–Ω
    let tasks = []; 
    let idx = 0;
    let right = 0; let wrong = 0; let startedAt = null; let perTaskTimer = null; let leftSec = 60;
    let isInverted = false; 
    const stateKey = 'mf-quest-savior-v1'; 

    // –ï–ª–µ–º–µ–Ω—Ç–∏
    const totalCountEl = document.getElementById('totalCount');
    const taskCounterEl = document.getElementById('taskCounter');
    const taskTitleEl = document.getElementById('taskTitle');
    const promptTextEl = document.getElementById('promptText');
    const optionsBoxEl = document.getElementById('optionsBox');
    const hintBtn = document.getElementById('hintBtn');
    const checkBtn = document.getElementById('checkBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const hintBox = document.getElementById('hintBox');
    const explainBox = document.getElementById('explainBox');
    const shuffleToggle = document.getElementById('shuffleToggle');
    const timedToggle = document.getElementById('timedToggle');
    const timerEl = document.getElementById('timer');
    const timerBox = document.getElementById('timerBox');
    const restartBtn = document.getElementById('restartBtn');
    const invertBtn = document.getElementById('invertBtn'); 

    const resultModal = document.getElementById('resultModal');
    const resRight = document.getElementById('resRight');
    const resWrong = document.getElementById('resWrong');
    const resTime = document.getElementById('resTime');
    const badgeBox = document.getElementById('badgeBox');
    const resTip = document.getElementById('resTip');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const restartModalBtn = document.getElementById('restartModalBtn');
    
    // –£—Ç—ñ–ª—ñ—Ç–∏
    const shuffle = (arr)=>{
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
    const fmtTime = (ms)=>{
      const sec = Math.round(ms/1000); const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`;
    }

    function showToast(message) {
        // –ó–∞–≥–ª—É—à–∫–∞, –æ—Å–∫—ñ–ª—å–∫–∏ –µ–ª–µ–º–µ–Ω—Ç toast –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π
        console.log("Toast:", message);
    }

    /**
     * –ì–æ—Ç—É—î –º–∞—Å–∏–≤ –∑–∞–≤–¥–∞–Ω—å –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É –≥—Ä–∏.
     */
    function processTasksForMode() {
        return TASKS_BASE.map(t => {
            if (isInverted) {
                return {
                    prompt: t.s_inv,
                    options: t.opts_inv,
                    correct: t.correct_inv,
                    hint: t.hint_inv || t.hint, 
                    explain: t.explain_inv,
                    rewrite: t.rewrite_inv,
                    original_prompt: t.s_inv
                };
            } else {
                return {
                    prompt: t.s,
                    options: t.opts,
                    correct: t.correct,
                    hint: t.hint,
                    explain: t.explain,
                    rewrite: t.rewrite,
                    original_prompt: t.s
                };
            }
        });
    }

    // –í–ò–î–ê–õ–ï–ù–û: saveState, loadState, –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ localStorage

    function resetAll(forceShuffle = false){
        tasks = processTasksForMode(); 
        if (shuffleToggle.checked || forceShuffle) {
            shuffle(tasks);
        }
        idx = 0; right = 0; wrong = 0; startedAt = new Date();
        clearInterval(perTaskTimer); leftSec = 60; timerEl.textContent = leftSec;
        timerBox.classList.toggle('hidden', !timedToggle.checked);
        invertBtn.classList.toggle('tab-active', isInverted); 
        taskTitleEl.textContent = isInverted ? '–û–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–∞–ø–æ–∑–∏—á–µ–Ω–Ω—è' : '–û–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–∫';
        render(); 
    }


    function startPerTaskTimer(){
      clearInterval(perTaskTimer);
      if(!timedToggle.checked) return;
      leftSec = 60; timerEl.textContent = leftSec;
      perTaskTimer = setInterval(()=>{
        leftSec--; timerEl.textContent = leftSec;
        if(leftSec<=0){
          clearInterval(perTaskTimer);
          lockOptions();
          revealAnswer(false, true); 
        }
      },1000);
    }

    function lockOptions(){
      optionsBoxEl.querySelectorAll('button.opt').forEach(b=>b.disabled=true);
      checkBtn.disabled = true;
      skipBtn.disabled = true; 
      hintBtn.disabled = true; 
    }
    function unlockOptions(){
      optionsBoxEl.querySelectorAll('button.opt').forEach(b=>b.disabled=false);
      checkBtn.disabled = false;
      skipBtn.disabled = false; 
      hintBtn.disabled = false; 
    }

    function render(){
      totalCountEl.textContent = tasks.length;
      // –í–ò–î–ê–õ–ï–ù–û: –ø—Ä–æ–≥—Ä–µ—Å, –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ UI
      taskCounterEl.textContent = `–ó–∞–≤–¥–∞–Ω–Ω—è ${Math.min(idx+1,tasks.length)}/${tasks.length}`;

      hintBox.classList.add('hidden'); hintBox.textContent='';
      explainBox.classList.add('hidden'); explainBox.innerHTML=''; 
      nextBtn.disabled = true;

      if(idx>=tasks.length){
        showResults();
        return;
      }

      const t = tasks[idx];
      promptTextEl.innerHTML = t.prompt; 
      optionsBoxEl.innerHTML = '';
      
      // –ü–µ—Ä–µ–º—ñ—à—É—î–º–æ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
      let optionIndices = Array.from(t.options.keys());
      if(shuffleToggle.checked) {
          shuffle(optionIndices);
      }
      
      optionIndices.forEach((originalIndex, i)=>{
        const opt = t.options[originalIndex];
        const btn = document.createElement('button');
        btn.className = 'opt text-left';
        btn.type='button';
        btn.setAttribute('data-i', originalIndex);
        // –í–ò–î–ê–õ–ï–ù–û: <span class="kbd">
        btn.innerHTML = `<span>${opt}</span>`;
        btn.setAttribute('aria-label', `–í–∞—Ä—ñ–∞–Ω—Ç ${String.fromCharCode(65+i)}: ${opt}`);
        btn.addEventListener('click', ()=>selectOption(originalIndex));
        optionsBoxEl.appendChild(btn);
      });
      unlockOptions(); 
      startPerTaskTimer(); 
    }

    let chosen = null;
    function selectOption(i){
      chosen = i;
      optionsBoxEl.querySelectorAll('.opt').forEach(b=>b.classList.remove('ring-2','ring-[var(--blue)]'));
      const current = optionsBoxEl.querySelector(`.opt[data-i="${i}"]`);
      current.classList.add('ring-2','ring-[var(--blue)]');
    }

    /**
     * –õ–æ–≥—ñ–∫–∞ –ø–æ–∫–∞–∑—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ "–ë—É–ª–æ/–°—Ç–∞–ª–æ"
     */
    function revealAnswer(isManualCheck=true, dueToTimer=false){
        const t = tasks[idx];
        const correct = t.correct;

        let isCorrectAnswer = (chosen === correct) && !dueToTimer;

        optionsBoxEl.querySelectorAll('.opt').forEach((b) => {
            const i = Number(b.getAttribute('data-i'));
            b.classList.remove('ring-2', 'ring-[var(--blue)]'); 
            if (i === correct) {
                b.classList.add('correct'); 
            }
            if (chosen !== null && i === chosen && !isCorrectAnswer) {
                b.classList.add('wrong');
            }
        });

        let fullExplanation = '';

        if (isCorrectAnswer) {
            right++;
            explainBox.className = 'mt-3 text-sm bg-green-50 border border-green-200 text-green-900 rounded-lg p-3';
            fullExplanation = `<div class="font-semibold mb-2 text-lg text-green-700">–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</div>`;
            fullExplanation += `<div class="mb-2">${t.explain}</div>`;
        } else {
            wrong++;
            explainBox.className = 'mt-3 text-sm bg-red-50 border border-red-200 text-red-900 rounded-lg p-3';
            fullExplanation = `<div class="font-semibold mb-2 text-lg text-red-700">–ù–∞ –∂–∞–ª—å, —Ü–µ –Ω–µ–≤—ñ—Ä–Ω–æ.</div>`;
            fullExplanation += `<div class="mb-2">${t.explain}</div>`;
        }

        if (t.rewrite) {
            let finalRewrite = t.rewrite;
            if (!isCorrectAnswer && chosen !== null) {
                const wrongText = t.options[chosen];
                finalRewrite = t.original_prompt.replace(/<b class="borrowed">(.*?)<\/b>/i, `<span class="answer-inline">${wrongText}</span>`);
            }
            fullExplanation += `
                <div class="explain-block">
                    <span>–ë—É–ª–æ:</span> <div class="explain-sentence">${t.original_prompt}</div>
                    <span>–°—Ç–∞–ª–æ:</span> <div class="explain-sentence">${finalRewrite}</div>
                </div>
            `;
        } else {
            const correctText = t.options[t.correct];
            let newSentence = t.original_prompt.replace(/<b class="borrowed">(.*?)<\/b>/i, `<span class="answer-inline">${correctText}</span>`);
            
            if (!isCorrectAnswer && chosen !== null) {
                const wrongText = t.options[chosen];
                newSentence = t.original_prompt.replace(/<b class="borrowed">(.*?)<\/b>/i, `<span class="answer-inline">${wrongText}</span>`);
            }
             fullExplanation += `
                <div class="explain-block">
                    <span>–ë—É–ª–æ:</span> <div class="explain-sentence">${t.original_prompt}</div>
                    <span>–°—Ç–∞–ª–æ:</span> <div class="explain-sentence">${newSentence}</div>
                </div>
            `;
        }

        if (dueToTimer) {
            fullExplanation += '<div class="mt-2 font-semibold">–ß–∞—Å –≤–∏—á–µ—Ä–ø–∞–Ω–æ.</div>';
        }

        hintBox.classList.add('hidden');
        explainBox.innerHTML = fullExplanation; 
        explainBox.classList.remove('hidden');

        nextBtn.disabled = false;
        lockOptions(); 
    }


    // –û–±—Ä–æ–±–Ω–∏–∫–∏
    hintBtn.addEventListener('click', ()=>{
      const t = tasks[idx];
      hintBox.classList.remove('hidden');
      hintBox.textContent = t.hint;
    });

    checkBtn.addEventListener('click', ()=>{
      if (chosen === null) {
        optionsBoxEl.classList.add('shake');
        setTimeout(() => optionsBoxEl.classList.remove('shake'), 500);
        showToast('–û–±–µ—Ä—ñ—Ç—å –≤–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ!');
        return; 
      }
      clearInterval(perTaskTimer); 
      revealAnswer(true, false);
    });

    nextBtn.addEventListener('click', ()=>{
      idx++; chosen=null; render(); 
    });

    skipBtn.addEventListener('click', ()=>{
        clearInterval(perTaskTimer); 
        idx++; chosen=null; render(); 
    });

    restartBtn.addEventListener('click', ()=>{ localStorage.removeItem(stateKey); resetAll(); }); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ localStorage.removeItem –ª–∏—à–µ –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏

    // –û–±—Ä–æ–±–Ω–∏–∫ —ñ–Ω–≤–µ—Ä—Å—ñ—ó
    invertBtn.addEventListener('click', ()=>{
      isInverted = !isInverted;
      resetAll();
      showToast(isInverted ? '–†–µ–∂–∏–º —ñ–Ω–≤–µ—Ä—Å—ñ—ó —É–≤—ñ–º–∫–Ω–µ–Ω–æ' : '–ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º —É–≤—ñ–º–∫–Ω–µ–Ω–æ');
    });

    // –ö–ª–∞–≤—ñ—à—ñ —à–≤–∏–¥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
    window.addEventListener('keydown', (e)=>{
      if (resultModal.open) return;
      if(['INPUT','TEXTAREA','BUTTON'].includes(document.activeElement.tagName)) return;

      const k = e.key.toLowerCase();
      // –ì–ê–†–Ø–ß–Ü –ö–õ–ê–í–Ü–®–Ü-–ë–£–ö–í–ò –í–ò–î–ê–õ–ï–ù–û
      if(k === 'h' && !hintBtn.disabled){ hintBtn.click(); e.preventDefault(); }
      if(e.key === 'Enter' && !checkBtn.disabled){ checkBtn.click(); e.preventDefault(); }
      if(k === 'n' && !nextBtn.disabled){ nextBtn.click(); e.preventDefault(); }
      if(k === 's' && !skipBtn.disabled){ skipBtn.click(); e.preventDefault(); }
    });

    function showResults(){
      const total = tasks.length; const ms = Date.now()-startedAt.valueOf();
      resRight.textContent = right; resWrong.textContent = wrong; resTime.textContent = fmtTime(ms);
      badgeBox.innerHTML = '';
      const rate = total > 0 ? right/total : 0; 
      const badges = [];
      if(rate===1) badges.push({name:'–°–ª–æ–≤–æ—Ä—è—Ç—ñ–≤–Ω–∏–∫ / —Ü—è', desc:'–ë–µ–∑–¥–æ–≥–∞–Ω–Ω–µ –≤–æ–ª–æ–¥—ñ–Ω–Ω—è –º–æ–≤–æ—é!'});
      else if(rate>=0.8) badges.push({name:'–ü—É—Ä–∏—Å—Ç / –∫–∞', desc:'–ß—É–¥–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –º–∞–π–∂–µ –±–µ–∑–¥–æ–≥–∞–Ω–Ω–æ.'});
      else if(rate>=0.6) badges.push({name:'–ó–Ω–∞–≤–µ—Ü—å / —á–∏–Ω—è', desc:'–ì–∞—Ä–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —î –∫—É–¥–∏ —Ä–æ—Å—Ç–∏.'});
      else badges.push({name:'–ü–æ–º—ñ—á–Ω–∏–∫ —Ä—è—Ç—ñ–≤–Ω–∏–∫–∞', desc:'–ù—ñ—á–æ–≥–æ, –ø—Ä–æ–¥–æ–≤–∂—É–π —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è.'});

      badges.forEach(b=>{
        const el = document.createElement('div');
        el.className = 'btn btn-ghost text-left flex-col items-start gap-0 p-3'; 
        el.style.transform = 'none'; // –í–∏–º–∏–∫–∞—î–º–æ hover-–µ—Ñ–µ–∫—Ç
        el.innerHTML = `<div class="font-semibold text-lg">üèÖ ${b.name}</div><div class="text-sm text-[var(--muted)]">${b.desc}</div>`;
        badgeBox.appendChild(el);
      });
      resTip.textContent = rate<0.8 ? '–ü–æ—Ä–∞–¥–∞: —Å–ø—Ä–æ–±—É–π –ø—Ä–æ–π—Ç–∏ —â–µ —Ä–∞–∑. –ü–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è ‚Äî –∫–ª—é—á –¥–æ —É—Å–ø—ñ—Ö—É!' : '–ß—É–¥–æ–≤–æ! –°–ø—Ä–æ–±—É–π —Ä–µ–∂–∏–º —ñ–Ω–≤–µ—Ä—Å—ñ—ó –∞–±–æ —Ç–∞–π–º–µ—Ä.';
      resultModal.showModal();
    }

    closeModalBtn.addEventListener('click', ()=>{ resultModal.close(); });
    restartModalBtn.addEventListener('click', ()=>{ resultModal.close(); resetAll(); }); // –í–ò–î–ê–õ–ï–ù–û localStorage.removeItem

    // –°—Ç–∞—Ä—Ç
    (function init(){
        shuffleToggle.addEventListener('change', () => {
            resetAll(shuffleToggle.checked);
        });
        
        timedToggle.addEventListener('change', () => {
            timerBox.classList.toggle('hidden', !timedToggle.checked);
            if (timedToggle.checked && idx < tasks.length && checkBtn.disabled === false) {
                 startPerTaskTimer();
            } else {
                 clearInterval(perTaskTimer);
            }
        });

        // –í–ò–î–ê–õ–ï–ù–û: loadState
        resetAll(shuffleToggle.checked); 
    })();
  </script>
</body>
</html>
